# ELK Stack Example Makefile
# GitHub: https://github.com/kyungseok-lee/elk-examples

.PHONY: help build up down logs clean dev-server dev-client setup

# ê¸°ë³¸ íƒ€ê²Ÿ
help:
	@echo "ELK Stack Example í”„ë¡œì íŠ¸"
	@echo "GitHub: https://github.com/kyungseok-lee/elk-examples"
	@echo ""
	@echo "ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:"
	@echo "  make setup       - í”„ë¡œì íŠ¸ ì´ˆê¸° ì„¤ì •"
	@echo "  make up          - ëª¨ë“  ì„œë¹„ìŠ¤ ì‹œì‘ (Docker Compose)"
	@echo "  make down        - ëª¨ë“  ì„œë¹„ìŠ¤ ì¤‘ì§€"
	@echo "  make logs        - ì„œë¹„ìŠ¤ ë¡œê·¸ í™•ì¸"
	@echo "  make build       - ëª¨ë“  ì´ë¯¸ì§€ ë¹Œë“œ"
	@echo "  make clean       - ì»¨í…Œì´ë„ˆ ë° ë³¼ë¥¨ ì •ë¦¬"
	@echo "  make dev-server  - Go ì„œë²„ ë¡œì»¬ ê°œë°œ ëª¨ë“œ"
	@echo "  make dev-client  - Next.js í´ë¼ì´ì–¸íŠ¸ ë¡œì»¬ ê°œë°œ ëª¨ë“œ"
	@echo "  make status      - ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸"
	@echo "  make filebeat    - Filebeat ìƒíƒœ í™•ì¸"

# í”„ë¡œì íŠ¸ ì´ˆê¸° ì„¤ì •
setup:
	@echo "ğŸ”§ í”„ë¡œì íŠ¸ ì´ˆê¸° ì„¤ì •ì„ ì‹œì‘í•©ë‹ˆë‹¤..."
	mkdir -p logs data/elasticsearch data/logstash data/filebeat/modules.d
	@echo "âœ… ì´ˆê¸° ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"

# Docker Compose ëª…ë ¹ì–´
up:
	@echo "ğŸš€ ELK Stack ì„œë¹„ìŠ¤ë“¤ì„ ì‹œì‘í•©ë‹ˆë‹¤..."
	docker compose up -d
	@echo "â³ ì„œë¹„ìŠ¤ ì¤€ë¹„ ëŒ€ê¸° ì¤‘..."
	sleep 45
	@echo "âœ… ì„œë¹„ìŠ¤ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"
	@echo "ğŸŒ Next.js í´ë¼ì´ì–¸íŠ¸: http://localhost:3000"
	@echo "ğŸŒ Kibana ëŒ€ì‹œë³´ë“œ: http://localhost:5601"
	@echo "ğŸŒ Elasticsearch: http://localhost:9200"

down:
	@echo "ğŸ›‘ ì„œë¹„ìŠ¤ë“¤ì„ ì¤‘ì§€í•©ë‹ˆë‹¤..."
	docker compose down

logs:
	@echo "ğŸ“‹ ì„œë¹„ìŠ¤ ë¡œê·¸ë¥¼ í™•ì¸í•©ë‹ˆë‹¤..."
	docker compose logs -f

build:
	@echo "ğŸ”¨ ëª¨ë“  ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤..."
	docker compose build

clean:
	@echo "ğŸ§¹ ì»¨í…Œì´ë„ˆì™€ ë³¼ë¥¨ì„ ì •ë¦¬í•©ë‹ˆë‹¤..."
	docker compose down -v
	docker system prune -f

status:
	@echo "ğŸ” ì„œë¹„ìŠ¤ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤..."
	docker compose ps

# ë¡œì»¬ ê°œë°œ ëª…ë ¹ì–´
dev-server:
	@echo "ğŸ”§ Go ì„œë²„ë¥¼ ë¡œì»¬ ê°œë°œ ëª¨ë“œë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤..."
	cd server && go run main.go

dev-client:
	@echo "ğŸ”§ Next.js í´ë¼ì´ì–¸íŠ¸ë¥¼ ë¡œì»¬ ê°œë°œ ëª¨ë“œë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤..."
	cd client && npm run dev

# ì˜ì¡´ì„± ì„¤ì¹˜
install-server:
	@echo "ğŸ“¦ Go ì„œë²„ ì˜ì¡´ì„±ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤..."
	cd server && go mod tidy

install-client:
	@echo "ğŸ“¦ Next.js í´ë¼ì´ì–¸íŠ¸ ì˜ì¡´ì„±ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤..."
	cd client && npm install

# ì „ì²´ ì„¤ì¹˜
install: install-server install-client
	@echo "âœ… ëª¨ë“  ì˜ì¡´ì„±ì´ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤!"

# í…ŒìŠ¤íŠ¸
test-server:
	@echo "ğŸ§ª Go ì„œë²„ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."
	cd server && go test ./...

test-client:
	@echo "ğŸ§ª Next.js í´ë¼ì´ì–¸íŠ¸ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."
	cd client && npm test

# ì „ì²´ í…ŒìŠ¤íŠ¸
test: test-server test-client
	@echo "âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"

# Filebeat ìƒíƒœ í™•ì¸
filebeat:
	@echo "ğŸ” Filebeat ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤..."
	docker compose logs filebeat
	@echo ""
	@echo "ğŸ“Š Filebeat í†µê³„:"
	docker compose exec filebeat filebeat test output

# ë¡œê·¸ íŒŒì¼ í™•ì¸
check-logs:
	@echo "ğŸ“‹ ë¡œê·¸ íŒŒì¼ì„ í™•ì¸í•©ë‹ˆë‹¤..."
	@echo "=== Go ì„œë²„ ë¡œê·¸ ==="
	@ls -la logs/ 2>/dev/null || echo "ë¡œê·¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
	@echo ""
	@echo "=== Docker ì»¨í…Œì´ë„ˆ ë¡œê·¸ ==="
	docker compose logs --tail=10

# ë°ì´í„° ë°±ì—…
backup:
	@echo "ğŸ’¾ ë°ì´í„°ë¥¼ ë°±ì—…í•©ë‹ˆë‹¤..."
	tar -czf backup-$(shell date +%Y%m%d-%H%M%S).tar.gz data/ logs/
	@echo "âœ… ë°±ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤: backup-$(shell date +%Y%m%d-%H%M%S).tar.gz"
